#!/bin/sh
# Navigate to frontend directory if not already there
if [ -f "package.json" ] && grep -q '"name": "sati-fe"' package.json 2>/dev/null; then
  # Already in sati-fe directory
  :
elif [ -d "sati-fe" ]; then
  cd sati-fe || exit 1
fi

echo "ğŸ” Running pre-commit checks (matching CI workflow)..."

# Format check (matches CI: format:check)
echo "ğŸ“ Checking formatting..."
npm run format:check || {
  echo "âŒ Format check failed. Run 'npm run format' to fix."
  exit 1
}

# Type check (matches CI: type-check)
echo "ğŸ”§ Checking types..."
npm run type-check || {
  echo "âŒ Type check failed."
  exit 1
}

# Lint (matches CI: lint) - only lint staged files to avoid blocking on pre-existing issues
echo "ğŸ§¹ Running linter on staged files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | xargs npx eslint || {
    echo "âŒ Lint failed on staged files."
    exit 1
  }
else
  echo "No TypeScript files to lint."
fi

# Tests (matches CI: npm test --passWithNoTests)
echo "ğŸ§ª Running tests..."
npm test -- --passWithNoTests || {
  echo "âŒ Tests failed."
  exit 1
}

echo "âœ… All pre-commit checks passed!"